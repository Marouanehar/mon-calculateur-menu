<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blueberry Evolution V3.4 - CDG Expert</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .tab-active { border-bottom: 4px solid #1d4ed8; color: #1d4ed8; font-weight: 800; }
        .row-group { background-color: #f1f5f9; font-weight: 800; font-size: 0.7rem; }
    </style>
</head>
<body class="min-h-screen text-slate-800">

    <header class="bg-slate-900 text-white shadow-2xl sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-2xl">ü´ê</span>
                <h1 class="text-sm font-black uppercase">Blueberry <span class="text-blue-400">V3.4 CDG</span></h1>
            </div>
            <nav id="navTabs" class="hidden flex gap-8 text-[10px] font-bold uppercase tracking-widest">
                <button onclick="switchTab('main')" class="tab-btn tab-active py-5" id="tab-main">Matrice Cuisines</button>
                <button onclick="switchTab('type')" class="tab-btn py-5" id="tab-type">Resto vs Bar</button>
                <button onclick="switchTab('pat')" class="tab-btn py-5" id="tab-pat">Pat/Glace/Burger par Site</button>
            </nav>
            <button onclick="exportReport()" class="bg-blue-600 px-4 py-2 rounded text-[10px] font-black uppercase">Exporter</button>
        </div>
    </header>

    <div id="setupPanel" class="max-w-4xl mx-auto mt-12 p-8 bg-white rounded-3xl shadow-xl border border-slate-200">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="p-4 bg-slate-50 rounded-xl border">
                <label class="block text-[10px] font-black uppercase mb-2">1. Base Familles</label>
                <input type="file" id="fileFamily" class="text-xs w-full">
            </div>
            <div class="p-4 bg-amber-50 rounded-xl border-amber-200 border">
                <label class="block text-[10px] font-black uppercase mb-2 text-amber-700">2. Ratios CGI (Ventilation)</label>
                <input type="file" id="fileCGI" class="text-xs w-full">
            </div>
            <div class="p-4 bg-slate-50 rounded-xl border">
                <label class="block text-[10px] font-black uppercase mb-2">3. Ventes 2025</label>
                <input type="file" id="file2025" class="text-xs w-full">
            </div>
            <div class="p-4 bg-slate-50 rounded-xl border">
                <label class="block text-[10px] font-black uppercase mb-2">4. Ventes 2026</label>
                <input type="file" id="file2026" class="text-xs w-full">
            </div>
        </div>
        <button onclick="processFiles()" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl uppercase tracking-widest text-xs">Calculer la r√©partition CDG</button>
    </div>

    <div id="dashboard" class="hidden max-w-7xl mx-auto p-6">
        
        <div id="page-main" class="tab-content bg-white rounded-xl shadow-sm overflow-hidden border">
            <table class="w-full text-left text-xs">
                <thead class="bg-slate-50 border-b">
                    <tr class="font-black uppercase text-slate-500">
                        <th class="p-4">Cuisines & Sites</th>
                        <th class="p-4 text-right">CA 2025</th>
                        <th class="p-4 text-right">CA 2026</th>
                        <th class="p-4 text-center">Evo %</th>
                    </tr>
                </thead>
                <tbody id="tableMain"></tbody>
            </table>
        </div>

        <div id="page-type" class="tab-content hidden space-y-4">
            <div class="bg-white rounded-xl shadow-sm overflow-hidden border">
                <table class="w-full text-left text-xs">
                    <thead class="bg-blue-900 text-white uppercase text-[10px]">
                        <tr>
                            <th class="p-4">Type d'Activit√©</th>
                            <th class="p-4 text-right">CA 2025</th>
                            <th class="p-4 text-right">CA 2026</th>
                            <th class="p-4 text-center">Evolution</th>
                        </tr>
                    </thead>
                    <tbody id="tableType"></tbody>
                </table>
            </div>
        </div>

        <div id="page-pat" class="tab-content hidden space-y-4">
            <div class="bg-white rounded-xl shadow-sm overflow-hidden border">
                <table class="w-full text-left text-xs">
                    <thead class="bg-emerald-800 text-white uppercase text-[10px]">
                        <tr>
                            <th class="p-4">Site</th>
                            <th class="p-4">Famille Focus</th>
                            <th class="p-4 text-right">CA 2025</th>
                            <th class="p-4 text-right">CA 2026</th>
                            <th class="p-4 text-center">Evo %</th>
                        </tr>
                    </thead>
                    <tbody id="tablePat"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let families = {}, repartitionMap = {}, globalData = [];
        const SITES_LIST = ["KENITRA", "MOHAMMEDIA", "ARRIBAT", "MEGA MALL", "CASA", "CHARIOT"];

        async function processFiles() {
            const f25 = document.getElementById('file2025').files[0];
            const f26 = document.getElementById('file2026').files[0];
            const fFam = document.getElementById('fileFamily').files[0];
            const fCGI = document.getElementById('fileCGI').files[0];

            if (!f25 || !f26 || !fFam || !fCGI) return alert("Importez les 4 fichiers.");

            const famRows = await readExcel(fFam);
            families = {};
            famRows.forEach(r => {
                const code = r['Code article'] || r['Code'];
                if(code) families[code] = { 
                    famille: (r['Famille'] || 'AUTRES').toUpperCase(),
                    // Logique RESTO vs BAR automatique (si non d√©fini dans l'Excel)
                    type: (r['Famille'] || "").toUpperCase().includes("BAR") || (r['Famille'] || "").toUpperCase().includes("BOISSON") ? "BAR" : "RESTO"
                };
            });

            const cgiRows = await readExcel(fCGI);
            repartitionMap = {};
            cgiRows.forEach(r => {
                const menu = (r['Menu'] || r['D√©signation'] || "").toUpperCase().trim();
                if(!menu) return;
                if(!repartitionMap[menu]) repartitionMap[menu] = [];
                repartitionMap[menu].push({ cuisine: (r['Cuisine'] || r['Famille Destination']).toUpperCase(), ratio: parseFloat(r['Pourcentage'] || r['Ratio']) / 100 });
            });

            const raw25 = await readExcel(f25);
            const raw26 = await readExcel(f26);

            calculateCDG(raw25, raw26);
            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('navTabs').classList.remove('hidden');
        }

        function readExcel(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                    resolve(XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]));
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function calculateCDG(d25, d26) {
            globalData = [];

            const process = (data, year) => {
                data.forEach(row => {
                    const design = (row['D√©signation'] || "").toUpperCase().trim();
                    const ca = parseFloat(row['CA HT'] || row['CA'] || 0);
                    const site = getSiteName((row['Nom Site'] || "").toUpperCase());
                    const code = row['Code article'] || row['Code'];

                    // SI C'EST UN MENU (CGI)
                    if (repartitionMap[design]) {
                        repartitionMap[design].forEach(comp => {
                            pushData(site, comp.cuisine, ca * comp.ratio, year, "RESTO");
                        });
                    } else {
                        const info = families[code] || { famille: "AUTRES", type: "RESTO" };
                        pushData(site, info.famille, ca, year, info.type);
                    }
                });
            };

            process(d25, 'ca25');
            process(d26, 'ca26');

            renderMain();
            renderType();
            renderPat();
        }

        function getSiteName(name) {
            for (const s of SITES_LIST) { if (name.includes(s)) return s; }
            return "RABAT SI√àGE";
        }

        function pushData(site, famille, ca, year, type) {
            let found = globalData.find(d => d.site === site && d.famille === famille);
            if (!found) {
                found = { site, famille, ca25: 0, ca26: 0, type };
                globalData.push(found);
            }
            found[year] += ca;
        }

        // RENDU PAGE 1 (MATRICE)
        function renderMain() {
            const tbody = document.getElementById('tableMain');
            tbody.innerHTML = '';
            
            // On regroupe par famille pour le si√®ge et par site pour les autres
            const cuisines = {};
            globalData.forEach(d => {
                let key = d.site === "RABAT SI√àGE" ? d.famille : "SITE " + d.site;
                if(!cuisines[key]) cuisines[key] = { name: key, ca25: 0, ca26: 0 };
                cuisines[key].ca25 += d.ca25;
                cuisines[key].ca26 += d.ca26;
            });

            Object.values(cuisines).forEach(r => tbody.appendChild(createRow(r)));
        }

        // RENDU PAGE 2 (RESTO VS BAR)
        function renderType() {
            const tbody = document.getElementById('tableType');
            tbody.innerHTML = '';
            const types = { "RESTO": { name: "TOTAL RESTAURATION", ca25: 0, ca26: 0 }, "BAR": { name: "TOTAL BAR / BOISSONS", ca25: 0, ca26: 0 } };
            
            globalData.forEach(d => {
                types[d.type].ca25 += d.ca25;
                types[d.type].ca26 += d.ca26;
            });
            Object.values(types).forEach(r => tbody.appendChild(createRow(r)));
        }

        // RENDU PAGE 3 (PAT/GLACE/BURGER PAR SITE)
        function renderPat() {
            const tbody = document.getElementById('tablePat');
            tbody.innerHTML = '';
            const focus = ["PATISSERIE", "GLACES ET SORBETS", "BURGER"];
            
            globalData.filter(d => focus.some(f => d.famille.includes(f)))
                .sort((a,b) => a.site.localeCompare(b.site))
                .forEach(d => {
                    const tr = document.createElement('tr');
                    const evo = d.ca25 > 0 ? ((d.ca26 - d.ca25)/d.ca25)*100 : 0;
                    tr.className = "border-b";
                    tr.innerHTML = `
                        <td class="p-4 font-bold text-slate-500">${d.site}</td>
                        <td class="p-4 font-black">${d.famille}</td>
                        <td class="p-4 text-right">${f(d.ca25)}</td>
                        <td class="p-4 text-right font-black">${f(d.ca26)}</td>
                        <td class="p-4 text-center font-bold ${evo > 0 ? 'text-emerald-500' : 'text-red-500'}">${evo.toFixed(1)}%</td>
                    `;
                    tbody.appendChild(tr);
                });
        }

        function createRow(r) {
            const tr = document.createElement('tr');
            const evo = r.ca25 > 0 ? ((r.ca26 - r.ca25)/r.ca25)*100 : 0;
            tr.className = "border-b hover:bg-slate-50";
            tr.innerHTML = `
                <td class="p-4 font-bold text-slate-700">${r.name}</td>
                <td class="p-4 text-right">${f(r.ca25)}</td>
                <td class="p-4 text-right font-black bg-blue-50/30 text-blue-900">${f(r.ca26)}</td>
                <td class="p-4 text-center font-bold ${evo > 0 ? 'text-emerald-500' : 'text-red-500'}">${evo.toFixed(1)}%</td>
            `;
            return tr;
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
            document.getElementById('page-' + id).classList.remove('hidden');
            document.getElementById('tab-' + id).classList.add('tab-active');
        }

        function f(n) { return Math.round(n).toLocaleString('fr-MA'); }

        function exportReport() {
            const ws = XLSX.utils.json_to_sheet(globalData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "D√©tail CDG");
            XLSX.writeFile(wb, "Blueberry_V3.4_CDG.xlsx");
        }
    </script>
</body>
</html>
